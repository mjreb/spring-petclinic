
name: CodeScene - Trigger Cloud Analysis

on:
  push:
    branches:
      - main

jobs:
  codescene-cloud-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger CodeScene analysis via REST API
        env:
          CS_API_TOKEN: ${{ secrets.CODESCENE_PAT }}        # Tu PAT de CodeScene
          CS_PROJECT_ID: ${{ secrets.CODESCENE_PROJECT_ID }} # Debe ser 74249
          BASE_URL: https://codescene.io
        run: |
          set -e
          echo "==> Disparando análisis para el proyecto ${CS_PROJECT_ID}..."
          HTTP_CODE=$(curl -sS -o /tmp/resp.json -w "%{http_code}" -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${CS_API_TOKEN}" \
            "${BASE_URL}/api/v2/projects/${CS_PROJECT_ID}/run-analysis")
          echo "HTTP ${HTTP_CODE}"
          cat /tmp/resp.json || true
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "ERROR: La API devolvió estado ${HTTP_CODE}"
            exit 1
          fi
          echo "OK: Análisis disparado correctamente."
