name: CodeScene CI/CD Analysis

on:
  push:
    branches:
      - main
      - master
      
jobs:
  analyze:
    runs-on: ubuntu-latest
    
    env:
      # ✅ CORREGIDO: Vuelve a ser la URL del SERVIDOR/API.
      CODESCENE_URL: "https://codescene.io" 
      CODESCENE_PROJECT: "spring-petclinic" 
      
    steps:
      - name: Checkout Repository with Full History
        uses: actions:checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run CodeScene Analysis and Quality Gate Check
        run: |
          echo "Descargando CodeScene CLI..."
          # ✅ CORRECTO: Usamos la URL directa y estática para la descarga.
          curl -L -f -sS -O "https://codescene.com/static/codescene-cli.jar" 

          # 3.1. Ejecuta el Análisis. Usamos la variable CODESCENE_URL (el servidor) aquí.
          echo "Iniciando análisis para el proyecto ${{ env.CODESCENE_PROJECT }}..."
          java -jar codescene-cli.jar analyze \
            --url "${{ env.CODESCENE_URL }}" \ 
            --project "${{ env.CODESCENE_PROJECT }}" \
            --repository "." \
            --accessToken "${{ secrets.CODESCENE_PAT }}" \
            --resultsFile "codescene-results.json"
            
          # 3.2. Verifica el Quality Gate.
          echo "Verificando Quality Gate..."
          java -jar codescene-cli.jar check-quality-gate \
            --resultsFile "codescene-results.json"
        
        shell: bash
