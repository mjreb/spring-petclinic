name: CodeScene CI/CD Analysis

# Define cu√°ndo se dispara el workflow: en cada 'push' a la rama principal
on:
  push:
    branches:
      - main
      - master
  # Tambi√©n puedes a√±adir 'pull_request' si quieres analizar antes de fusionar:
  # pull_request:
  #   branches:
  #     - main
      
jobs:
  analyze:
    runs-on: ubuntu-latest
    
    # Define las variables a usar
    env:
      CODESCENE_URL: "https://codescene.com/static/codescene-cli.jar"
      CODESCENE_PROJECT: "spring-petclinic" # Tu nombre de proyecto en CodeScene
      
    steps:
      # 1. Checkout del c√≥digo
      # ¬°CRUCIAL!: fetch-depth: 0 asegura que CodeScene pueda analizar el historial de Git
      - name: Checkout Repository with Full History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. Configura Java (necesario para la CodeScene CLI)
      - name: Set up Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' # Java 17 o superior es recomendado

      # 3. Descarga, Ejecuta el An√°lisis y Verifica el Quality Gate
      # 3. Descarga, Ejecuta el An√°lisis y Verifica el Quality Gate
      - name: Run CodeScene Analysis and Quality Gate Check
        run: |
          echo "Descargando CodeScene CLI desde la nueva URL..."
          # üö® CAMBIO DE URL: Usaremos la URL de descarga directa y est√°tica
          curl -L -f -sS -O "https://codescene.com/static/codescene-cli.jar"

          # 3.1. Ejecuta el An√°lisis.
          # Utilizamos los secretos de GitHub para el token (CODESCENE_PAT)
          echo "Iniciando an√°lisis para el proyecto ${{ env.CODESCENE_PROJECT }}..."
          java -jar codescene-cli.jar analyze \
            --url "${{ env.CODESCENE_URL }}" \
            --project "${{ env.CODESCENE_PROJECT }}" \
            --repository "." \
            --accessToken "${{ secrets.CODESCENE_PAT }}" \
            --resultsFile "codescene-results.json"
            
          # 3.2. Verifica el Quality Gate (Umbral de Calidad).
          echo "Verificando Quality Gate..."
          java -jar codescene-cli.jar check-quality-gate \
            --resultsFile "codescene-results.json"
        
        shell: bash
